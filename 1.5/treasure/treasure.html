<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <div class="input-row">
        <p>amount:</p>
        <input type="number" value=20 id="treasureAmount" style="width: 70px; font-family: monospace; padding-right: 0,2rem;" oninput="calcTreasure()"></input>
    </div>
    <div id="showTreasureHere"></div>
</body>
</html>

<script>
    var save;
    var parameters = {};
    
    window.addEventListener('message', function(event) {
        if (event.data.action === 'jsException'){return;}
        save = JSON.parse(atob(event.data));
        calcTreasure()
    });
    
    function calcTreasure() {
        let myGlobalLevel = getGl()
        const div = document.getElementById("showTreasureHere");
        while(div.firstChild){
            div.removeChild(div.firstChild);
        }
        let amount = document.getElementById("treasureAmount").value;
        if (amount < 1 && amount > 10000) {amount = 20}
        for (let i = 0; i < amount; i++) {
            let seed = save.playerId + "treasureTier_" + ((save.rng.treasureTier_regular ?? 0) + i)
            let rngGen = new Math.seedrandom(seed);
            const nextChance = rngGen();
            let tier = getTier(myGlobalLevel, nextChance)
            let nextGl
                        
            for (let currentGL = myGlobalLevel; currentGL < myGlobalLevel + 1000; currentGL++) {
                if (getTier(currentGL, nextChance) !== tier)
                {
                    nextGl = currentGL;
                    break;
                }
            }
            generateTreasure(tier, nextGl, i)
        }
    }

    function generateTreasure(tier, nextGl, i){
        let seed = save.playerId + "treasure_regular_" + ((save.rng.treasure_regular ?? 0) + i)
        let rngGen = new Math.seedrandom(seed);
        let randomValue = rngGen()
        let chosenEffect = [];
        const effectList = generateEffectList()
        let chosenElem = randomElem(effectList, randomValue);
        //effectList = effectList.filter(el => el !== chosenElem); dual
        chosenEffect.push(chosenElem);
        let type = chosenEffect[0]
        
        let icon = mapTypeToIcon(type)
        let color = mapTierToColor(tier)
        let strenght =  (tier * mapTypeToStrenght(type)) + 1
        let effectName = mapTypeToText(type)
        const showTreasureHere = document.getElementById("showTreasureHere");
        const div = document.createElement("div");
        const iconContainer = document.createElement("i");
        const textContainer = document.createElement("p");
        iconContainer.style.fontSize = "40px";
        iconContainer.classList.add("mdi")
        iconContainer.classList.add(icon)
        iconContainer.style.color = color
        textContainer.innerText = effectName + " " + strenght
        div.appendChild(iconContainer);
        div.appendChild(textContainer);
        showTreasureHere.appendChild(div);
    }

    function generateEffectList(){
        let unlocks = save.unlock;
        let effectList = [];
        effectList.push("miningDamage");
        effectList.push("currencyMiningScrapGain");
        effectList.push("miningOreGain");
        "miningSmeltery" in unlocks ? effectList.push("miningSmelterySpeed") : null;
        "miningSmoke" in unlocks ? effectList.push("currencyMiningSmokeGain") : null;
        effectList.push("queueSpeedVillageBuilding");
        effectList.push("villageMaterialGain");
        effectList.push("currencyVillageCoinGain");
        effectList.push("villageMentalGain");
        effectList.push("hordeAttack");
        effectList.push("currencyHordeBoneGain");
        effectList.push("currencyHordeMonsterPartGain");
        "hordeItemMastery" in unlocks ? effectList.push("hordeItemMasteryGain") : null;
        effectList.push("currencyFarmVegetableGain");
        effectList.push("currencyFarmBerryGain");
        effectList.push("currencyFarmGrainGain");
        effectList.push("currencyFarmFlowerGain");
        effectList.push("currencyGalleryBeautyGain");
        "galleryConversion" in unlocks ? effectList.push("currencyGalleryConverterGain") : null;
        "galleryDrums" in unlocks ? effectList.push("currencyGalleryPackageGain") : null;
        return effectList;
    }

    function getTier(gl = getGl(), nextChance){
        let tier = null
        let totalChance = 0;
        tierChancesRaw(gl).forEach(elem => {
            totalChance += elem.chance;
            if (tier === null && chance(totalChance, nextChance)) {
                tier = elem.tier;
            }
        })
        return tier        
    }

    function tierChancesRaw(gl = getGl()) {
        let arr = [];
        let tier = 0;
        let totalChance = 0;
        const upgradeChances = tierChances(gl);
        if (upgradeChances.length <= 0) {
            return [{tier: 0, chance: 1}];
        }
        upgradeChances.forEach((elem, key) => {
            if (elem < 1) {
                const chance = (1 - totalChance) * (1 - elem)
                arr.push({tier, chance});
                totalChance += chance;
            }
            tier++;
            if ((key + 1) >= upgradeChances.length) {
                arr.push({tier, chance: (1 - totalChance)});
            }
        });
        return arr;
    }
    
    function tierChances(gl) {
        let chances = [];
        let chanceValue = gl / 1000;
        while (chanceValue > 0) {
            chances.push(chanceValue);
            chanceValue *= 0.9;
            chanceValue -= 0.2;
        }
        return chances;
    }
    
</script>
<script src="https://myros27.github.io/gooberer/1.5/utils/myros.js"></script>
<script src="https://myros27.github.io/gooberer/1.5/utils/random.js"></script>
<script src="https://myros27.github.io/gooberer/1.5/utils/seedrandom.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/MaterialDesign-Webfont/7.4.47/css/materialdesignicons.min.css">
<link rel="stylesheet" href="https://myros27.github.io/gooberer/1.5/menu/menu.css">
