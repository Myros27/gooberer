<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <p id="playerId"></p>
    <p>example</p>
</body>
</html>

<script>

    var save;
    var settings;
    var nextEvents;
    var parameters = new URLSearchParams(document.location.search)
    
    window.addEventListener('message', function(event) {
        let receivedData = JSON.parse(atob(event.data));
        if (receivedData.action !== 'initData' || receivedData.action === 'jsException') {
            return;
        }
        save = receivedData.save;
        settings = receivedData.settings;
        feature();
    });

    function feature(){
        document.getElementById("playerId").innerText = save.playerId
        nextEvents = returnNextEvents()
    }

    function returnNextEvents(day = null){
        let arr = [];
        let small = ["merchant", "casino", "bank"];
        const big = JSON.parse('{"cinders":{"start":"01-15","end":"02-03","color":"amber","currency":"wax","token":"cindersToken"},' +
            '"bloom":{"start":"03-09","end":"03-31","color":"light-green","currency":"humus","token":"bloomToken"},' +
            '"weatherChaos":{"start":"05-22","end":"06-08","color":"grey","currency":"cloud","token":"weatherChaosToken"},' +
            '"summerFestival":{"start":"07-26","end":"08-22","color":"orange-red","currency":"cocktail","token":"summerFestivalToken"},' +
            '"nightHunt":{"start":"10-04","end":"10-19","color":"deep-purple","currency":"magic","token":"nightHuntToken"},' +
            '"snowdown":{"start":"11-25","end":"12-15","color":"skyblue","currency":"snowball","token":"snowdownToken"}}')

        const now = new Date(`${day ?? new Date().toISOString().split("T")[0]}T00:00:00`);
        const year = now.getFullYear();
        const month = now.getMonth() + 1;

        const min = new Date(now.getFullYear(), now.getMonth(), 1);
        const max = new Date(now.getFullYear(), now.getMonth() + 1, 0);

        const firstday = new Date(min.setDate(min.getDate() - (min.getDay() === 0 ? 6 : min.getDay() - 1)));
        const lastday = new Date(max.setDate(max.getDate() - (max.getDay() === 0 ? 6 : max.getDay() - 1) + 6));
        console.log(now)
        for (const [key, elem] of Object.entries(big)) {
            if (month >= parseInt(elem.start.substring(0, 2)) && month <= parseInt(elem.end.substring(0, 2))) {
                arr.push({
                    name: key,
                    color: elem.color,
                    start: new Date(`${year}-${elem.start}T00:00:00`),
                    end: new Date(`${year}-${elem.end}T23:59:59`)
                });
            }
        }

        let timestamp = getDay(firstday);
        let weeks = [];
        while ((new Date(`${timestamp}T00:00:00`)) <= lastday) {
            weeks.push(timestamp);
            let newDate = new Date(`${timestamp}T00:00:00`);
            newDate.setDate(newDate.getDate() + 7)
            timestamp = getDay(newDate);
        }

        weeks.forEach(week => {
            let startCompare = new Date(`${week}T00:00:00`);
            startCompare.setDate(startCompare.getDate() + 4);
            let startDate = new Date(`${week}T00:00:00`);
            startDate.setDate(startDate.getDate() + 5);
            let endCompare = new Date(`${week}T23:59:59`);
            endCompare.setDate(endCompare.getDate() + 7);
            let endDate = new Date(`${week}T23:59:59`);
            endDate.setDate(endDate.getDate() + 6);
            if (arr.findIndex(el => el.start <= endCompare && el.end >= startCompare) === -1) {
                arr.push({
                    name: small[getWeek(startDate) % small.length],
                    start: startDate,
                    end: endDate
                });
            }
        });
        return arr;
    }


    
</script>
<script src="https://myros27.github.io/gooberer/1.5/utils/date.js"></script>
<link rel="stylesheet" href="https://myros27.github.io/gooberer/1.5/utils/icons/css/materialdesignicons.css">
<link rel="stylesheet" href="https://myros27.github.io/gooberer/1.5/menu/menu.css">

